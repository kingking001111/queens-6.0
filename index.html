<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Queens â€” Logic Mini Game</title>
  <meta name="description" content="Queens â€” a LinkedIn-inspired logic mini game. Place X then Queens, solve with unique solutions." />
  <style>
    /* ---------- Design tokens ---------- */
    :root{
      --bg: #0b0f17;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.08);
      --border: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --muted2: rgba(255,255,255,.52);
      --danger: #ff4d4d;
      --ok: #3ddc97;

      --radius: 18px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);

      --cell: 56px;
      --gap: 10px;
    }

    @media (prefers-color-scheme: light){
      :root{
        --bg: #f6f7fb;
        --panel: rgba(0,0,0,.04);
        --panel2: rgba(0,0,0,.06);
        --border: rgba(0,0,0,.10);
        --text: rgba(0,0,0,.88);
        --muted: rgba(0,0,0,.62);
        --muted2: rgba(0,0,0,.48);
        --shadow: 0 10px 30px rgba(0,0,0,.12);
      }
    }

    *{ box-sizing: border-box; }
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(99,102,241,.25), transparent 55%),
                  radial-gradient(900px 600px at 110% 20%, rgba(61,220,151,.18), transparent 55%),
                  var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Arial;
      line-height: 1.45;
    }

    a{ color: inherit; }
    .container{
      max-width: 1120px;
      margin: 0 auto;
      padding: 22px 18px 36px;
    }

    /* ---------- Header ---------- */
    .top{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 14px;
      margin-bottom: 16px;
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap: 6px;
    }
    .title{
      font-size: 22px;
      font-weight: 800;
      letter-spacing: .2px;
      margin: 0;
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .pill{
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--panel2);
      border: 1px solid var(--border);
      color: var(--muted);
      font-weight: 700;
    }
    .subtitle{
      margin: 0;
      color: var(--muted);
      font-size: 13px;
    }

    /* ---------- Layout ---------- */
    .grid{
      display:grid;
      grid-template-columns: 1fr 340px;
      gap: 16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .cardHeader{
      padding: 14px 14px 12px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .cardHeader .left{
      display:flex; flex-direction:column; gap: 4px;
    }
    .cardHeader h2{
      margin:0;
      font-size: 14px;
      letter-spacing: .2px;
    }
    .cardHeader p{
      margin:0;
      font-size: 12px;
      color: var(--muted);
    }

    /* ---------- Controls ---------- */
    .controls{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      align-items:center;
      padding: 12px 14px;
    }
   .btn, select{
  appearance:none;
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 10px 12px;
  font-weight: 750;
  font-size: 13px;
  cursor: pointer;
  transition: transform .06s ease, background .15s ease, border-color .15s ease;
}

/* âœ… select å›ºå®šç™½åº•é»‘å­—ï¼Œé¿å…çœ‹ä¸æ¸…æ¥š */
select{
  padding-right: 34px;
  background: #fff;
  color: #111;
  border-color: rgba(0,0,0,.18);
}

/* option çš„æ¨£å¼åœ¨ä¸åŒç€è¦½å™¨æ”¯æ´åº¦ä¸ä¸€ï¼Œä½†åŠ äº†é€šå¸¸æœƒæ›´ç©© */
select option{
  background: #fff;
  color: #111;
}

    .split{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .meta{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      align-items:center;
      padding: 0 14px 14px;
    }
    .badge{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 750;
      display:inline-flex;
      gap: 6px;
      align-items:center;
    }
    .dot{
      width:8px; height:8px; border-radius:999px; background: var(--muted2);
    }
    .dot.ok{ background: var(--ok); }
    .dot.bad{ background: var(--danger); }

    /* ---------- Board ---------- */
    .boardWrap{
      padding: 14px;
      display:flex;
      justify-content:center;
    }
    .board{
      .board{
  display:grid;
  gap: 2px; /* âœ… ç·šçš„ç²—ç´° */
  padding: 2px; /* å¤–æ¡†ä¹Ÿæœ‰ç·š */
  border-radius: 16px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,.75); /* âœ… ç·šçš„é¡è‰²ï¼ˆäº®ï¼‰ */
  box-shadow: 0 8px 22px rgba(0,0,0,.18);
}
@media (prefers-color-scheme: light){
  .board{ background: rgba(0,0,0,.18); } /* æ·ºè‰²æ¨¡å¼ç”¨æ·±ç·šæ›´æ¸…æ¥š */
}

    .cell{
      width: var(--cell);
      height: var(--cell);
     
      display:grid;
      place-items:center;
      font-size: 24px;
      position:relative;
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease, filter .15s ease;
    }
    .cell:hover{ filter: brightness(1.04); }
    .cell:active{ transform: scale(.985); }

    .cell.grey{
      background: rgba(255,255,255,.07);
    }
    
    .cell.conflict{
      outline: 3px solid rgba(255,77,77,.85);
      outline-offset: -3px;
      z-index: 1;
    }

    /* ---------- Sidebar ---------- */
    .sideBody{ padding: 14px; }
    .rule{
      margin:0 0 10px;
      color: var(--muted);
      font-size: 13px;
    }
    .rule strong{ color: var(--text); }
    .kbd{
      font-family: ui-monospace, Menlo, Consolas, monospace;
      font-size: 12px;
      padding: 2px 7px;
      border-radius: 9px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--muted);
    }
    .mono{ font-family: ui-monospace, Menlo, Consolas, monospace; }

    /* ---------- Toast ---------- */
    .toast{
      position: fixed;
      right: 16px;
      bottom: 16px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.55);
      color: rgba(255,255,255,.9);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      transform: translateY(10px);
      opacity: 0;
      pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
      font-weight: 750;
      font-size: 13px;
      max-width: 86vw;
    }
    @media (prefers-color-scheme: light){
      .toast{ background: rgba(255,255,255,.75); color: rgba(0,0,0,.86); }
    }
    .toast.show{ opacity: 1; transform: translateY(0); }

    /* ---------- Confetti ---------- */
    .confetti{
      position: fixed;
      inset: 0;
      pointer-events:none;
      overflow:hidden;
    }
    .confetti i{
      position:absolute;
      width: 10px; height: 14px;
      border-radius: 2px;
      opacity: .9;
      transform: translateY(-20px);
      animation: fall 900ms ease-in forwards;
    }
    @keyframes fall{
      to { transform: translateY(105vh) rotate(340deg); opacity: 0.2; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="top">
      <div class="brand">
        <h1 class="title">Queens <span class="pill">Unique Puzzle</span></h1>
        <p class="subtitle">é»ä¸€ä¸‹æ”¾ <b>X</b>ã€é»å…©ä¸‹æ”¾ <b>ğŸ‘‘</b>ã€å†é»æ¸…ç©ºã€‚ç°è‰²æ ¼ä¹Ÿèƒ½åšç­†è¨˜ï¼Œä½†éé—œåªèªæœ‰è‰²æ ¼çš„ ğŸ‘‘ã€‚</p>
      </div>
      <div class="split">
        <button class="btn ghost" id="shareBtn" title="è¤‡è£½åŒä¸€é¡Œçš„é€£çµ">Share</button>
        <button class="btn ghost" id="dailyBtn" title="æ¯å¤©å›ºå®šåŒä¸€é¡Œ">Daily</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="cardHeader">
          <div class="left">
            <h2>Play</h2>
            <p>æ¯é¡Œä¿è­‰å”¯ä¸€è§£ã€‚ç°è‰² ğŸ‘‘ æœƒè¢«æ¨™ç´…æé†’ï¼ˆä¸ç®—éé—œï¼‰ã€‚</p>
          </div>
          <div class="split">
            <select id="size">
              <option value="6">6Ã—6</option>
              <option value="7">7Ã—7</option>
              <option value="8" selected>8Ã—8ï¼ˆæ¨è–¦ï¼‰</option>
              <option value="9">9Ã—9</option>
            </select>
            <button class="btn primary" id="newBtn">New</button>
          </div>
        </div>

        <div class="controls">
          <button class="btn" id="clearBtn">Clear</button>
          <button class="btn" id="checkBtn">Check</button>
          <button class="btn danger" id="solveBtn">Reveal</button>
        </div>

        <div class="meta">
          <span class="badge"><span class="dot" id="statusDot"></span><span id="statusText">-</span></span>
          <span class="badge">ğŸ‘‘ <span id="qCount">0</span>/<span id="n">8</span></span>
          <span class="badge">Seed <span class="mono" id="seedText">-</span></span>
        </div>

        <div class="boardWrap">
          <div id="board" class="board" aria-label="board"></div>
        </div>
      </div>

      <div class="card">
        <div class="cardHeader">
          <div class="left">
            <h2>Rules</h2>
            <p>LinkedIn Queens-inspired</p>
          </div>
        </div>
        <div class="sideBody">
          <p class="rule">ç›®æ¨™ï¼šæ¯è¡Œã€æ¯åˆ—ã€æ¯å€‹<strong>è‰²å¡Šå€åŸŸ</strong>æ°å¥½ 1 å€‹ <strong>ğŸ‘‘</strong>ã€‚</p>
          <p class="rule">é™åˆ¶ï¼šä»»ä½•å…©å€‹ <strong>ğŸ‘‘</strong> ä¸èƒ½ç›¸é„°ï¼ˆåŒ…å«æ–œå°è§’ï¼‰ã€‚</p>
          <p class="rule">æ“ä½œï¼šé»ä¸€ä¸‹æ”¾ Xï¼Œé»å…©ä¸‹æ”¾ ğŸ‘‘ï¼Œå†é»æ¸…ç©ºã€‚</p>
          <p class="rule">æç¤ºï¼šç°è‰²æ ¼å¯ä»¥ç”¨ä¾†æ¨™è¨˜æ¨ç†ï¼Œä½†<strong>ç°è‰²ğŸ‘‘ä¸ç®—éé—œ</strong>ï¼ˆæœƒæ¨™ç´…ï¼‰ã€‚</p>

          <div style="height:10px"></div>
          <p class="rule mono">ğŸ‘‘åº§æ¨™ï¼š<span id="posText"></span></p>

          <div style="height:10px"></div>
          <p class="rule">å°å¿«æ·éµï¼ˆå¯é¸ï¼‰ï¼š<span class="kbd">N</span> æ–°é¡Œã€<span class="kbd">C</span> æ¸…ç©ºã€<span class="kbd">K</span> æª¢æŸ¥ã€‚</p>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>
  <div class="confetti" id="confetti"></div>

<script>
(() => {
  /* ===================== RNG ===================== */
  function mulberry32(a) {
    return function() {
      let t = a += 0x6D2B79F5;
      t = Math.imul(t ^ (t >>> 15), t | 1);
      t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    };
  }
  function randInt(rng, lo, hi){ return lo + Math.floor(rng()*(hi-lo)); }
  function shuffle(rng, arr){
    for(let i=arr.length-1;i>0;i--){
      const j = randInt(rng,0,i+1);
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
  }
  function isAdj(r1,c1,r2,c2){ return Math.abs(r1-r2)<=1 && Math.abs(c1-c2)<=1; }

  /* ===================== DOM ===================== */
  const boardEl = document.getElementById('board');
  const sizeSel = document.getElementById('size');
  const newBtn = document.getElementById('newBtn');
  const clearBtn = document.getElementById('clearBtn');
  const checkBtn = document.getElementById('checkBtn');
  const solveBtn = document.getElementById('solveBtn');
  const shareBtn = document.getElementById('shareBtn');
  const dailyBtn = document.getElementById('dailyBtn');

  const statusDot = document.getElementById('statusDot');
  const statusText = document.getElementById('statusText');
  const qCountEl = document.getElementById('qCount');
  const nEl = document.getElementById('n');
  const seedText = document.getElementById('seedText');
  const posText = document.getElementById('posText');

  const toastEl = document.getElementById('toast');
  const confettiEl = document.getElementById('confetti');

  /* ===================== State ===================== */
  let N = 8;
  let seed = 0;
  let rng = Math.random;

  // regionGrid: -1 grey, 0..N-1 colored region id
  let regionGrid = [];
  // cellState: 0 empty, 1 X, 2 Queen
  let cellState = [];
  let cells = [];
  let regionColors = [];
  let solution = []; // [row] -> col for the unique solution

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    window.clearTimeout(toastEl._t);
    toastEl._t = window.setTimeout(()=>toastEl.classList.remove('show'), 1400);
  }

  function setStatus(kind, text){
    statusText.textContent = text;
    statusDot.classList.remove('ok','bad');
    if (kind === 'ok') statusDot.classList.add('ok');
    else if (kind === 'bad') statusDot.classList.add('bad');
  }

  function initCellState(){
    cellState = Array.from({length:N}, ()=>Array(N).fill(0));
  }

  function countQueens(){
    let cnt=0;
    for(let r=0;r<N;r++) for(let c=0;c<N;c++) if(cellState[r][c]===2) cnt++;
    return cnt;
  }
  function queenPositions(){
    const out=[];
    for(let r=0;r<N;r++) for(let c=0;c<N;c++) if(cellState[r][c]===2) out.push([r,c]);
    return out;
  }

  /* ===================== Generation ===================== */
  function genBaseSolutionOnlyNoAdj(){
    const state = Array(N).fill(-1);
    const usedCols = new Set();

    function backtrack(row){
      if(row===N) return true;
      const cols = shuffle(rng, Array.from({length:N},(_,i)=>i));
      for(const col of cols){
        if(usedCols.has(col)) continue;
        let ok=true;
        for(let r=0;r<row;r++){
          const c = state[r];
          if(isAdj(r,c,row,col)){ ok=false; break; }
        }
        if(!ok) continue;
        state[row]=col;
        usedCols.add(col);
        if(backtrack(row+1)) return true;
        usedCols.delete(col);
        state[row]=-1;
      }
      return false;
    }

    for(let tries=0; tries<320; tries++){
      usedCols.clear();
      state.fill(-1);
      if(backtrack(0)) return state.slice();
    }
    return null;
  }

  function buildSparseRegionsFromSolution(sol){
    const grid = Array.from({length:N}, ()=>Array(N).fill(-1));

    // region size 4 or 5
    const k = randInt(rng, 0, N + 1);
    const sizes = Array(N).fill(4);
    const ids = shuffle(rng, Array.from({length:N},(_,i)=>i));
    for(let i=0;i<k;i++) sizes[ids[i]]=5;

    // seed each region at (row=regionId, col=solution[row])
    for(let reg=0; reg<N; reg++){
      grid[reg][sol[reg]] = reg;
    }

    const fronts = Array.from({length:N}, ()=>[]);
    function addNeighbors(reg,r,c){
      const dirs=[[1,0],[-1,0],[0,1],[0,-1]];
      for(const [dr,dc] of dirs){
        const nr=r+dr, nc=c+dc;
        if(nr<0||nr>=N||nc<0||nc>=N) continue;
        if(grid[nr][nc]!==-1) continue;
        fronts[reg].push([nr,nc]);
      }
    }
    for(let reg=0; reg<N; reg++) addNeighbors(reg, reg, sol[reg]);

    const cur = Array(N).fill(1);
    let guard=0;
    while(true){
      guard++; if(guard>25000) return null;
      let done=true;
      for(let reg=0; reg<N; reg++){ if(cur[reg]<sizes[reg]){ done=false; break; } }
      if(done) break;

      const candidates=[];
      for(let reg=0; reg<N; reg++){
        if(cur[reg]<sizes[reg] && fronts[reg].length>0) candidates.push(reg);
      }
      if(!candidates.length) return null;

      candidates.sort((a,b)=> (sizes[b]-cur[b])-(sizes[a]-cur[a]));
      const pickBand = Math.min(candidates.length, 3);
      const reg = candidates[randInt(rng,0,pickBand)];

      let chosen=null;
      for(let t=0; t<14 && fronts[reg].length; t++){
        const idx=randInt(rng,0,fronts[reg].length);
        const [r,c]=fronts[reg][idx];
        fronts[reg][idx]=fronts[reg][fronts[reg].length-1];
        fronts[reg].pop();
        if(grid[r][c]===-1){ chosen=[r,c]; break; }
      }
      if(!chosen) continue;

      const [rr,cc]=chosen;
      grid[rr][cc]=reg;
      cur[reg]+=1;
      addNeighbors(reg,rr,cc);
    }
    return grid;
  }

  function buildColors(){
  // Golden angle palette: better separation than linear hue steps
  const golden = 137.508; // degrees
  regionColors = Array.from({length:N}, (_,i)=>{
    const hue = (i * golden + (seed % 97)) % 360;
    const sat = 82;
    const light = (i % 2 === 0) ? 82 : 74; // alternate lightness for contrast
    return `hsl(${hue} ${sat}% ${light}%)`;
  });
}


  // count solutions for REAL win condition (colored only), stop at 2
  function countSolutions(maxSolutions=2){
    let count=0;
    const colUsed=Array(N).fill(false);
    const regUsed=Array(N).fill(false);
    const placedCol=Array(N).fill(-1);

    function dfs(r){
      if(count>=maxSolutions) return;
      if(r===N){ count++; return; }
      for(let c=0;c<N;c++){
        const reg=regionGrid[r][c];
        if(reg===-1) continue;
        if(colUsed[c]) continue;
        if(regUsed[reg]) continue;
        if(r>0){
          const pc=placedCol[r-1];
          if(pc!==-1 && Math.abs(pc-c)<=1) continue;
        }
        colUsed[c]=true; regUsed[reg]=true; placedCol[r]=c;
        dfs(r+1);
        colUsed[c]=false; regUsed[reg]=false; placedCol[r]=-1;
      }
    }
    dfs(0);
    return count;
  }

  /* ===================== UI Build ===================== */
  function buildBoard(){
    boardEl.innerHTML='';
    boardEl.style.gridTemplateColumns = `repeat(${N}, var(--cell))`;
    boardEl.style.gridTemplateRows = `repeat(${N}, var(--cell))`;

    cells = Array.from({length:N}, ()=>Array(N).fill(null));

    for(let r=0;r<N;r++){
      for(let c=0;c<N;c++){
        const d=document.createElement('div');
        d.className='cell';
        const reg=regionGrid[r][c];
        if(reg===-1){
          d.classList.add('grey');
        } else {
          d.style.background = regionColors[reg];
          
        }
        d.addEventListener('click', ()=>cycleCell(r,c));
        boardEl.appendChild(d);
        cells[r][c]=d;
      }
    }
  }

  function cycleCell(r,c){
    cellState[r][c] = (cellState[r][c] + 1) % 3; // empty->X->Q->empty
    updateUI();
  }

  function computeConflicts(){
    const queens=queenPositions();
    const bad=new Set();

    const rowCount=Array(N).fill(0);
    const colCount=Array(N).fill(0);
    const regCount=Array(N).fill(0);

    for(const [r,c] of queens){
      rowCount[r]++; colCount[c]++;
      const reg=regionGrid[r][c];
      if(reg>=0) regCount[reg]++;
    }

    for(const [r,c] of queens){
      const reg=regionGrid[r][c];
      if(reg===-1) bad.add(`${r},${c}`); // grey queen invalid
      if(rowCount[r]>1 || colCount[c]>1) bad.add(`${r},${c}`);
      if(reg>=0 && regCount[reg]>1) bad.add(`${r},${c}`);
    }

    for(let i=0;i<queens.length;i++){
      for(let j=i+1;j<queens.length;j++){
        const [r1,c1]=queens[i], [r2,c2]=queens[j];
        if(isAdj(r1,c1,r2,c2)){
          bad.add(`${r1},${c1}`);
          bad.add(`${r2},${c2}`);
        }
      }
    }
    return bad;
  }

  function updateUI(){
    // clear marks/conflict
    for(let r=0;r<N;r++){
      for(let c=0;c<N;c++){
        const d=cells[r][c];
        d.classList.remove('conflict');
        // remove text nodes (X/Q)
        d.childNodes.forEach(node=>{
          if(node.nodeType===Node.TEXT_NODE) d.removeChild(node);
        });
      }
    }

    // draw X/Q
    for(let r=0;r<N;r++){
      for(let c=0;c<N;c++){
        if(cellState[r][c]===1) cells[r][c].appendChild(document.createTextNode('X'));
        if(cellState[r][c]===2) cells[r][c].appendChild(document.createTextNode('ğŸ‘‘'));
      }
    }

    const qCnt=countQueens();
    qCountEl.textContent=String(qCnt);

    const bad=computeConflicts();
    bad.forEach(k=>{
      const [r,c]=k.split(',').map(Number);
      cells[r][c].classList.add('conflict');
    });

    const list=queenPositions().map(([r,c])=>{
      const col=String.fromCharCode(65+c);
      return `${col}${r+1}`;
    }).join(', ');
    posText.textContent=list;

    if(qCnt===0){ setStatus('', '-'); }
    else if(bad.size>0){ setStatus('bad', 'Conflict'); }
    else { setStatus('ok', 'Clean'); }
  }

  function clearAll(){
    for(let r=0;r<N;r++) for(let c=0;c<N;c++) cellState[r][c]=0;
    updateUI();
    setStatus('', '-');
  }

  function checkWin(){
    const queens=queenPositions();
    const bad=computeConflicts();

    if(queens.length!==N){
      setStatus('bad', `Need ${N} queens`);
      toast(`ğŸ‘‘ æ•¸é‡ä¸å°ï¼ˆ${queens.length}/${N}ï¼‰`);
      return;
    }
    for(const [r,c] of queens){
      if(regionGrid[r][c]===-1){
        setStatus('bad', 'Grey queen');
        toast('ç°è‰²æ ¼ä¸Šçš„ ğŸ‘‘ ä¸ç®—éé—œ');
        return;
      }
    }
    if(bad.size>0){
      setStatus('bad', 'Conflict');
      toast('æœ‰è¡çªï¼ˆç´…æ¡†è™•ï¼‰');
      return;
    }

    // exactly 1 per row/col/region
    const row=Array(N).fill(0), col=Array(N).fill(0), reg=Array(N).fill(0);
    for(const [r,c] of queens){
      row[r]++; col[c]++; reg[regionGrid[r][c]]++;
    }
    for(let i=0;i<N;i++){
      if(row[i]!==1 || col[i]!==1 || reg[i]!==1){
        setStatus('bad','Not exact');
        toast('è¡Œ/åˆ—/å€åŸŸéœ€æ°å¥½ 1 å€‹ ğŸ‘‘');
        return;
      }
    }

    setStatus('ok', 'Solved!');
    toast('å®Œæˆ âœ…');
    confetti();
  }

  function reveal(){
    clearAll();
    for(let r=0;r<N;r++){
      cellState[r][solution[r]]=2;
    }
    updateUI();
    setStatus('ok', 'Revealed');
  }

  /* ===================== Confetti ===================== */
  function confetti(){
    confettiEl.innerHTML='';
    const colors = ['#60a5fa','#34d399','#fbbf24','#f472b6','#a78bfa','#fb7185'];
    for(let i=0;i<24;i++){
      const p=document.createElement('i');
      const left = Math.random()*100;
      p.style.left = left+'vw';
      p.style.top = (-10 - Math.random()*20)+'px';
      p.style.background = colors[Math.floor(Math.random()*colors.length)];
      p.style.animationDelay = (Math.random()*120)+'ms';
      p.style.transform = `translateY(-20px) rotate(${Math.random()*90}deg)`;
      confettiEl.appendChild(p);
    }
    window.setTimeout(()=>confettiEl.innerHTML='', 1200);
  }

  /* ===================== Share / Daily / Seed ===================== */
  function getSeedFromUrl(){
    const u = new URL(window.location.href);
    const s = u.searchParams.get('seed');
    if(!s) return null;
    const n = Number(s);
    if(Number.isFinite(n) && n>=0) return n >>> 0;
    return null;
  }
  function setSeedInUrl(s){
    const u = new URL(window.location.href);
    u.searchParams.set('seed', String(s>>>0));
    history.replaceState({}, '', u.toString());
  }
  function removeSeedInUrl(){
    const u = new URL(window.location.href);
    u.searchParams.delete('seed');
    history.replaceState({}, '', u.toString());
  }
  function dailySeed(){
    const d = new Date();
    const y=d.getFullYear(), m=d.getMonth()+1, day=d.getDate();
    // simple stable hash
    let x = (y*10000 + m*100 + day) >>> 0;
    x ^= 0x9e3779b9;
    x = Math.imul(x ^ (x >>> 16), 0x85ebca6b);
    x = Math.imul(x ^ (x >>> 13), 0xc2b2ae35);
    x = (x ^ (x >>> 16)) >>> 0;
    return x;
  }
  async function copyLink(){
    try{
      await navigator.clipboard.writeText(window.location.href);
      toast('é€£çµå·²è¤‡è£½');
    }catch{
      toast('è¤‡è£½å¤±æ•—ï¼ˆç€è¦½å™¨é™åˆ¶ï¼‰');
    }
  }

  /* ===================== Puzzle Generation (Unique Only) ===================== */
  function genPuzzle({forcedSeed=null}={}){
    setStatus('', 'Generatingâ€¦');

    N = parseInt(sizeSel.value, 10);
    nEl.textContent = String(N);

    seed = (forcedSeed ?? ((Date.now() ^ (Math.random()*1e9))>>>0)) >>> 0;
    rng = mulberry32(seed);
    seedText.textContent = String(seed);

    buildColors();

    for(let attempt=0; attempt<1200; attempt++){
      const sol = genBaseSolutionOnlyNoAdj();
      if(!sol) continue;

      const reg = buildSparseRegionsFromSolution(sol);
      if(!reg) continue;

      regionGrid = reg;

      // unique filter
      const num = countSolutions(2);
      if(num !== 1) continue;

      solution = sol;
      initCellState();
      buildBoard();
      updateUI();

      setStatus('', '-');
      return true;
    }
    setStatus('bad', 'Failed');
    toast('ç”Ÿæˆå¤±æ•—ï¼Œè«‹å†æŒ‰ä¸€æ¬¡ New');
    return false;
  }

  /* ===================== Events ===================== */
  newBtn.addEventListener('click', ()=>{
    removeSeedInUrl();
    genPuzzle();
  });
  clearBtn.addEventListener('click', ()=>{ clearAll(); toast('å·²æ¸…ç©º'); });
  checkBtn.addEventListener('click', checkWin);
  solveBtn.addEventListener('click', ()=>{ reveal(); toast('é¡¯ç¤ºè§£'); });

  shareBtn.addEventListener('click', ()=>{
    // ensure seed is in URL so others get the same puzzle
    setSeedInUrl(seed);
    copyLink();
  });

  dailyBtn.addEventListener('click', ()=>{
    const ds = dailySeed();
    setSeedInUrl(ds);
    genPuzzle({forcedSeed: ds});
    toast('Daily é¡Œç›®');
  });

  sizeSel.addEventListener('change', ()=>{
    const s = getSeedFromUrl();
    genPuzzle({forcedSeed: s});
  });

  document.addEventListener('keydown', (e)=>{
    if(e.key==='n' || e.key==='N'){ removeSeedInUrl(); genPuzzle(); }
    if(e.key==='c' || e.key==='C'){ clearAll(); }
    if(e.key==='k' || e.key==='K'){ checkWin(); }
  });

  // initial
  const urlSeed = getSeedFromUrl();
  if(urlSeed !== null){
    genPuzzle({forcedSeed: urlSeed});
  } else {
    genPuzzle();
  }
})();
</script>
</body>
</html>
